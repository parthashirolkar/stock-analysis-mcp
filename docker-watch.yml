version: '3.8'

services:
  stock-analysis-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    image: indian-stock-mcp:latest
    container_name: indian-stock-mcp-server
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=ERROR
      - TZ=Asia/Kolkata
    entrypoint: ["tail", "-f", "/dev/null"]

  # File watcher service
  docker-rebuild:
    image: alpine:latest
    container_name: docker-rebuild-watcher
    volumes:
      - ./:/app
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /app
    command: |
      sh -c "
        apk add --no-cache inotify-tools &&
        echo 'ğŸ‘€ Watching for file changes...' &&
        while true; do
          inotifywait -r -e modify,create,delete,move --exclude '\\.git|node_modules|__pycache__' /app &&
          echo 'ğŸ“ Files changed, rebuilding Docker image...' &&
          docker-compose build stock-analysis-mcp &&
          echo 'ğŸ”„ Restarting container...' &&
          docker-compose up -d stock-analysis-mcp &&
          echo 'âœ… Rebuild complete!'
        done
      "
    depends_on:
      - stock-analysis-mcp